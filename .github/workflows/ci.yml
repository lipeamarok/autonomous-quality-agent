name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  PYTHON_VERSION: "3.11"

jobs:
  # =============================================================================
  # Python Tests (Brain)
  # =============================================================================
  python-tests:
    name: Python Tests
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        working-directory: brain
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run tests
        working-directory: brain
        run: |
          python -m pytest tests/ -v --tb=short

      - name: Run tests with coverage
        working-directory: brain
        run: |
          python -m pytest tests/ --cov=src --cov-report=xml --cov-report=term-missing

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: brain/coverage.xml
          flags: python
        continue-on-error: true

  # =============================================================================
  # Rust Tests (Runner)
  # =============================================================================
  rust-tests:
    name: Rust Tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-action@stable
        with:
          components: clippy, rustfmt

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            runner/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Check formatting
        working-directory: runner
        run: cargo fmt --all -- --check

      - name: Clippy
        working-directory: runner
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Run tests
        working-directory: runner
        run: cargo test --all-features

      - name: Build release
        working-directory: runner
        run: cargo build --release

  # =============================================================================
  # Integration Test
  # =============================================================================
  integration:
    name: Integration Test
    runs-on: ubuntu-latest
    needs: [python-tests, rust-tests]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Set up Rust
        uses: dtolnay/rust-action@stable

      - name: Install Python dependencies
        working-directory: brain
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Build Rust runner
        working-directory: runner
        run: cargo build --release

      - name: Test CLI help
        run: |
          aqa --help
          aqa --version

      - name: Test validate command
        working-directory: brain
        run: |
          echo '{"meta":{"name":"test","version":"1.0"},"config":{"base_url":"http://example.com"},"steps":[]}' > test-plan.json
          aqa validate test-plan.json

  # =============================================================================
  # Lint & Type Check
  # =============================================================================
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        working-directory: brain
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install pyright

      - name: Type check
        working-directory: brain
        run: |
          pyright src/
        continue-on-error: true  # Warnings allowed for now
